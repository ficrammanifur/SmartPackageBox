app.py

from flask import Flask, request, jsonify
from flask_cors import CORS
import google.generativeai as genai
import os
from dotenv import load_dotenv
import paho.mqtt.client as mqtt
import json

load_dotenv()
app = Flask(__name__)
CORS(app)

# ================= MQTT SETUP =================
MQTT_BROKER = "broker.hivemq.com"
MQTT_PORT = 1883
MQTT_PUB_TOPIC = "package/chat"        # Kirim perintah ke ESP32
MQTT_SUB_TOPIC = "package/confirm"     # Opsional: terima konfirmasi

mqtt_client = mqtt.Client()
mqtt_client.connect(MQTT_BROKER, MQTT_PORT, 60)
mqtt_client.loop_start()

def send_to_esp32(command):
    mqtt_client.publish(MQTT_PUB_TOPIC, command)
    print(f"üì° ‚Üí ESP32: {command}")

# Tambahkan subscribe untuk konfirmasi
MQTT_SUB_TOPIC_CONFIRM = "package/confirm"

def on_mqtt_message(client, userdata, msg):
    payload = msg.payload.decode()
    print(f"üì• Konfirmasi dari ESP32: {payload}")
    userdata['last_confirm'] = payload  # Simpan untuk kurir_suara cek

mqtt_client.on_message = on_mqtt_message
mqtt_client.user_data_set({'last_confirm': None})
mqtt_client.subscribe(MQTT_SUB_TOPIC_CONFIRM)

# ================= GEMINI AI SETUP =================
genai.configure(api_key=os.getenv('GEMINI_API_KEY'))

MODEL_NAME = "gemini-1.5-flash"

model = genai.GenerativeModel(
    MODEL_NAME,
    system_instruction="""
Kamu adalah asisten pintar untuk Smart Package Box.
Tugasmu: dari ucapan pengguna, tentukan apakah nama yang disebutkan termasuk dalam daftar penerima paket resmi.

Daftar nama resmi (case-insensitive):
- aisyah
- rabiathul
- nadia

Aturan:
1. Jika ucapan mengandung salah satu nama di atas (bisa dengan tambahan kata seperti "untuk", "buat", "mbak", "paket untuk", dll), kembalikan JSON:
   {"action": "open", "name": "NamaAsli"}

2. Jika nama tidak ada di daftar, kembalikan:
   {"action": "deny", "message": "Maaf, nama tidak terdaftar."}

3. Jika belum jelas atau tidak ada nama sama sekali, kembalikan:
   {"action": "ask_name", "message": "Paket atas nama siapa ya?"}

Hanya kembalikan JSON valid. Jangan tambahkan teks lain.
Contoh:
Input: "Paket untuk Aisyah"
Output: {"action": "open", "name": "Aisyah"}

Input: "Ini buat Budi"
Output: {"action": "deny", "message": "Maaf, nama tidak terdaftar."}
"""
)

# Fallback whitelist
WHITELIST = ["aisyah", "rabiathul", "nadia"]

def extract_name_with_gemini(text):
    try:
        response = model.generate_content(text)
        result = json.loads(response.text.strip())
        return result
    except Exception as e:
        print(f"[Gemini Error] Fallback aktif: {e}")
        text_lower = text.lower()
        for name in WHITELIST:
            if name in text_lower:
                return {"action": "open", "name": name.capitalize()}
        return {"action": "deny", "message": "Maaf, nama tidak terdaftar."}

# ================= ROUTE UTAMA =================
@app.route('/package-voice', methods=['POST'])
def handle_voice_input():
    try:
        data = request.get_json()
        if not data or 'text' not in data:
            return jsonify({"error": "Text input required"}), 400

        user_speech = data['text'].strip()
        print(f"üë§ Pengguna berkata: {user_speech}")

        decision = extract_name_with_gemini(user_speech)

        action = decision.get("action")
        name = decision.get("name")
        message = decision.get("message", "")

        if action == "open":
            # KIRIM PERINTAH KE ESP32: buka kotak
            send_to_esp32(f"name:{name.lower()}")
            return jsonify({
                "status": "success",
                "action": "open",
                "name": name,
                "speak": f"Selamat! Paket untuk {name}. Kotak akan terbuka sekarang."
            })

        elif action == "deny":
            send_to_esp32("invalid_name")
            return jsonify({
                "status": "success",
                "action": "deny",
                "speak": message or "Maaf, nama tidak terdaftar. Paket tidak bisa diambil."
            })

        elif action == "ask_name":
            send_to_esp32("ask_name")
            return jsonify({
                "status": "success",
                "action": "ask_name",
                "speak": message
            })

        else:
            return jsonify({"error": "Unknown action"}), 500

    except Exception as e:
        print(f"[ERROR] {e}")
        return jsonify({"error": "Server error"}), 500

@app.route('/health')
def health():
    return jsonify({"status": "OK", "model": MODEL_NAME})

if __name__ == '__main__':
    print("üöÄ Smart Package Box AI Bridge dengan Gemini aktif!")
    print(f"   Model: {MODEL_NAME}")
    print("   Siap menerima suara ‚Üí analisis ‚Üí kontrol ESP32")
    app.run(host='0.0.0.0', port=5000, debug=True)
	
requirements.txt
# requirements.txt - Dependencies for Smart Package Box (app.py)
# Install with: pip install -r requirements.txt
# Notes: 
# - PyAudio mungkin perlu build tools di Windows/Linux (e.g., apt install portaudio19-dev)
# - SpeechRecognition butuh PyAudio untuk mic input
# - gTTS untuk TTS (Google Text-to-Speech)
# - pydub untuk audio format handling

paho-mqtt>=1.6.1
google-generativeai>=0.3.2
SpeechRecognition>=3.10.0
gTTS>=0.0.0
pydub>=0.25.1
python-dotenv>=1.0.0
PyAudio>=0.2.11  # Untuk microphone input (platform-dependent)

test.py
import paho.mqtt.client as mqtt
import time

BROKER = "broker.hivemq.com"
PORT = 1883

PUB_TOPIC = "package/chat"
SUB_TOPIC = "package/confirm"

def on_connect(client, userdata, flags, rc):
    print("‚úÖ MQTT connected")
    client.subscribe(SUB_TOPIC)

def on_message(client, userdata, msg):
    print("üì© ESP32:", msg.payload.decode())

client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message

client.connect(BROKER, PORT, 60)
client.loop_start()

print("\n=== Smart Package Box Test ===")
print("Ketik:")
print("  trigger  ‚Üí ESP32 tanya nama")
print("  nama xxx ‚Üí kirim nama (contoh: nama Aisah)")
print("  exit     ‚Üí keluar\n")

while True:
    user_input = input(">> ").strip()
import time
import speech_recognition as sr
import pyttsx3
import requests
import paho.mqtt.client as mqtt

# ================= KONFIG =================
FLASK_SERVER_URL = "http://127.0.0.1:5000/package-voice"
MQTT_BROKER = "broker.hivemq.com"
MQTT_CHAT_TOPIC = "package/chat"
MQTT_STATUS_TOPIC = "package/status"

# ================= MQTT HANDLER =================
status = ""

def on_status(client, userdata, msg):
    global status
    payload = msg.payload.decode()
    status = payload
    print(f"Status dari ESP32: {payload}")

mqtt_client = mqtt.Client()
mqtt_client.connect(MQTT_BROKER, 1883, 60)
mqtt_client.subscribe(MQTT_STATUS_TOPIC)
mqtt_client.on_message = on_status
mqtt_client.loop_start()

def send_command(command):
    mqtt_client.publish(MQTT_CHAT_TOPIC, command)
    print(f"Perintah dikirim: {command}")

# ================= TTS & STT =================
engine = pyttsx3.init()
engine.setProperty("rate", 145)

def speak(text, delay=1.0):
    print("ü§ñ Kurir:", text)
    engine.say(text)
    engine.runAndWait()
    time.sleep(delay)

r = sr.Recognizer()
mic = sr.Microphone()

def listen(timeout=10):
    with mic as source:
        print("üéß Mendengarkan...")
        r.adjust_for_ambient_noise(source, duration=0.5)
        audio = r.listen(source, timeout=timeout, phrase_time_limit=10)
    try:
        text = r.recognize_google(audio, language="id-ID").lower()
        print(f"üë§ Pengguna: {text}")
        return text
    except:
        return ""

# ================= FLOW =================
print("üöö Smart Kurir Paket Aktif!")
speak("Permisi, ada paket untuk diantar.", 0.8)
speak("Paket ini atas nama siapa ya?")

while True:
    user_input = listen()
    if not user_input:
        speak("Maaf, saya tidak mendengar. Bisa diulangi namanya?")
        continue

    try:
        response = requests.post(FLASK_SERVER_URL, json={"text": user_input}, timeout=10)
        result = response.json()

        if result.get("status") == "success":
            speak(result.get("speak"))

            if result.get("action") == "open":
                # Kirim perintah buka ke ESP32
                send_command(f"name:{result.get('name', '').lower()}")

                # Tunggu konfirmasi opened
                status = ""
                for _ in range(20):
                    if status == "opened":
                        break
                    time.sleep(0.5)

                speak("Kotak sudah terbuka. Silakan ambil paketnya sekarang.")

                # Tanya selesai
                speak("Apakah sudah selesai mengambil paketnya?")
                reply = listen(timeout=15)

                if "sudah" in reply or "ya" in reply or "selesai" in reply:
                    send_command("close_box")
                    status = ""
                    for _ in range(20):
                        if status == "closed":
                            break
                        time.sleep(0.5)
                    speak("Terima kasih sudah mengambil paketnya. Selamat ya!")
                else:
                    speak("Waktu habis. Kotak akan ditutup.")
                    send_command("close_box")

                break

            elif result.get("action") == "deny":
                speak("Maaf, paket tidak bisa diambil.")
                break

    except Exception as e:
        print("Error:", e)
        speak("Sistem bermasalah.")
        break

mqtt_client.loop_stop()
print("Sesi selesai.")

voice_test.py
import speech_recognition as sr
import paho.mqtt.client as mqtt
import time

BROKER = "broker.hivemq.com"
PORT = 1883
PUB_TOPIC = "package/chat"

# MQTT
client = mqtt.Client()
client.connect(BROKER, PORT, 60)
client.loop_start()

print("üéôÔ∏è Voice Test Ready")
print("Ucapkan nama (Aisah / Rabiathul / Nadiyah)")
print("Ctrl+C untuk keluar\n")

recognizer = sr.Recognizer()
mic = sr.Microphone()

try:
    while True:
        with mic as source:
            recognizer.adjust_for_ambient_noise(source, duration=0.5)
            print("üéß Listening...")
            audio = recognizer.listen(source)

        try:
            text = recognizer.recognize_google(audio, language="id-ID")
            print("üó£Ô∏è Heard:", text)

            name = text.strip().lower()
            client.publish(PUB_TOPIC, f"name:{name}")
            print(f"üì§ Sent name:{name}\n")

        except sr.UnknownValueError:
            print("‚ùå Tidak jelas, ulangi...\n")
        except sr.RequestError as e:
            print("‚ö†Ô∏è Speech API error:", e)

        time.sleep(0.5)

except KeyboardInterrupt:
    print("\n‚õî Stop")

client.loop_stop()
client.disconnect()

    if not user_input:
        continue

    if user_input.lower() == "exit":
        print("‚õî Exit")
        break

    elif user_input.lower() == "trigger":
        client.publish(PUB_TOPIC, "trigger_detected")
        print("üì§ Trigger sent")

    else:
        # APAPUN YANG DIKETIK DIANGGAP NAMA
        name = user_input.strip()
        client.publish(PUB_TOPIC, f"name:{name}")
        print(f"üì§ Name sent: {name}")

    time.sleep(0.2)

client.loop_stop()
client.disconnect()

voice_ai.py
